name: Build and Release

on:
  push:
    branches:
      - fabric/1.21.x
      - fabric/1.20.x
      - forge/1.21.x
      - forge/1.20.x
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release:
        description: 'Create a release'
        required: false
        default: 'false'
        type: boolean

env:
  MOD_NAME: PromptCraft
  MOD_VERSION: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      mod_file: ${{ steps.find_jar.outputs.mod_file }}
      branch_name: ${{ steps.branch_info.outputs.branch_name }}
      loader_type: ${{ steps.branch_info.outputs.loader_type }}
      mc_version: ${{ steps.branch_info.outputs.mc_version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get branch info
        id: branch_info
        run: |
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # Determine loader type and MC version from branch name
          if [[ "$BRANCH_NAME" == fabric/* ]]; then
            LOADER_TYPE="fabric"
          elif [[ "$BRANCH_NAME" == forge/* ]]; then
            # Check if it's actually NeoForge (1.21.x)
            if [[ "$BRANCH_NAME" == *"1.21"* ]]; then
              LOADER_TYPE="neoforge"
            else
              LOADER_TYPE="forge"
            fi
          else
            LOADER_TYPE="fabric"
          fi
          
          if [[ "$BRANCH_NAME" == *"1.21"* ]]; then
            MC_VERSION="1.21"
          elif [[ "$BRANCH_NAME" == *"1.20"* ]]; then
            MC_VERSION="1.20"
          else
            MC_VERSION="unknown"
          fi
          
          echo "loader_type=$LOADER_TYPE" >> $GITHUB_OUTPUT
          echo "mc_version=$MC_VERSION" >> $GITHUB_OUTPUT
          
          echo "Branch: $BRANCH_NAME"
          echo "Loader: $LOADER_TYPE"
          echo "MC Version: $MC_VERSION"
      
      - name: Set up JDK 21
        if: contains(github.ref, '1.21')
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Set up JDK 17
        if: contains(github.ref, '1.20')
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build with Gradle
        run: ./gradlew build --no-daemon
      
      - name: Find built JAR
        id: find_jar
        run: |
          # Find the mod JAR (exclude sources and dev jars)
          MOD_FILE=$(find build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-dev.jar" | head -1)
          if [ -z "$MOD_FILE" ]; then
            echo "Error: No mod JAR found!"
            exit 1
          fi
          echo "Found: $MOD_FILE"
          echo "mod_file=$MOD_FILE" >> $GITHUB_OUTPUT
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.MOD_NAME }}-${{ steps.branch_info.outputs.loader_type }}-${{ steps.branch_info.outputs.mc_version }}
          path: build/libs/*.jar
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true')
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.MOD_NAME }}-${{ needs.build.outputs.loader_type }}-${{ needs.build.outputs.mc_version }}
          path: ./artifacts
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build.outputs.loader_type }}-${{ needs.build.outputs.mc_version }}-${{ steps.date.outputs.date }}
          name: "${{ env.MOD_NAME }} ${{ env.MOD_VERSION }} - ${{ needs.build.outputs.loader_type }} ${{ needs.build.outputs.mc_version }}"
          body: |
            ## PromptCraft ${{ env.MOD_VERSION }}
            
            **分支**: `${{ needs.build.outputs.branch_name }}`
            **加载器**: ${{ needs.build.outputs.loader_type }}
            **Minecraft 版本**: ${{ needs.build.outputs.mc_version }}
            **构建时间**: ${{ steps.date.outputs.date }}
            
            ### 安装说明
            1. 下载下方的 JAR 文件
            2. 将 JAR 文件放入 `.minecraft/mods` 文件夹
            3. 确保已安装对应的模组加载器
            
            ---
            
            自动构建 by GitHub Actions
          files: ./artifacts/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
