name: Build and Release

on:
  push:
    branches:
      - fabric/1.21.x
      - fabric/1.20.x
      - forge/1.21.x
      - forge/1.20.x
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      release:
        description: 'Create a release'
        required: false
        default: 'false'
        type: boolean

env:
  MOD_NAME: PromptCraft
  MOD_VERSION: '1.0.0'

jobs:
  build:
    runs-on: ubuntu-latest
    
    outputs:
      mod_file: ${{ steps.find_jar.outputs.mod_file }}
      branch_name: ${{ steps.build_info.outputs.branch_name }}
      loader_type: ${{ steps.build_info.outputs.loader_type }}
      mc_version: ${{ steps.build_info.outputs.mc_version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get build info
        id: build_info
        shell: bash
        run: |
          set -euo pipefail

          REF_TYPE="${GITHUB_REF_TYPE:-}" # branch / tag
          REF_NAME="${GITHUB_REF_NAME:-}"

          BRANCH_NAME="$REF_NAME"
          if [[ "$REF_TYPE" == "tag" ]]; then
            # Try to resolve which branch contains the tagged commit
            RESOLVED_BRANCH=$(git branch -r --contains "$GITHUB_SHA" | sed 's#^ *##' | sed 's#^origin/##' | head -n 1 || true)
            if [[ -n "$RESOLVED_BRANCH" ]]; then
              BRANCH_NAME="$RESOLVED_BRANCH"
            else
              BRANCH_NAME="tag/$REF_NAME"
            fi
          fi

          # Read minecraft version from gradle.properties (shared key across fabric/forge/neoforge)
          MC_VERSION_FULL=$(grep -E '^minecraft_version=' gradle.properties | head -n 1 | cut -d= -f2- | tr -d '\r')
          if [[ -z "$MC_VERSION_FULL" ]]; then
            echo "Error: minecraft_version not found in gradle.properties"
            exit 1
          fi

          # Use major.minor for naming consistency (e.g. 1.20.1 -> 1.20)
          MC_VERSION=$(echo "$MC_VERSION_FULL" | cut -d. -f1,2)

          # Infer loader type from gradle.properties keys
          if grep -qE '^neo_version=' gradle.properties; then
            LOADER_TYPE="neoforge"
          elif grep -qE '^forge_version=' gradle.properties; then
            LOADER_TYPE="forge"
          else
            LOADER_TYPE="fabric"
          fi

          # Infer Java version from Minecraft version
          JAVA_VERSION="17"
          if [[ "$MC_VERSION_FULL" == 1.21* ]]; then
            JAVA_VERSION="21"
          fi

          echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          echo "loader_type=$LOADER_TYPE" >> "$GITHUB_OUTPUT"
          echo "mc_version=$MC_VERSION" >> "$GITHUB_OUTPUT"
          echo "java_version=$JAVA_VERSION" >> "$GITHUB_OUTPUT"

          echo "Ref type: $REF_TYPE"
          echo "Ref name: $REF_NAME"
          echo "Branch: $BRANCH_NAME"
          echo "Loader: $LOADER_TYPE"
          echo "Minecraft version: $MC_VERSION_FULL"
          echo "Java version: $JAVA_VERSION"

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ steps.build_info.outputs.java_version }}
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-disabled: true
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Build with Gradle
        shell: bash
        run: |
          set -euo pipefail

          set +e
          ./gradlew build --no-daemon --stacktrace --warning-mode all 2>&1 | tee gradle-build.log
          GRADLE_EXIT=${PIPESTATUS[0]}
          set -e

          if [[ $GRADLE_EXIT -ne 0 ]]; then
            echo "::error title=Gradle build failed::Exit code $GRADLE_EXIT"

            SUMMARY=$(grep -nE "^FAILURE:|^\* What went wrong:|^\* Exception is:|^Caused by:|Could not resolve|Could not (GET|HEAD)" gradle-build.log | head -n 30 || true)
            if [[ -n "$SUMMARY" ]]; then
              while IFS= read -r line; do
                SHORT=$(echo "$line" | cut -c1-300)
                echo "::error title=Gradle output::$SHORT"
              done <<< "$SUMMARY"
            fi

            TAIL=$(tail -n 60 gradle-build.log | tr '\n' ' ' | cut -c1-800)
            echo "::error title=Gradle tail::$TAIL"

            exit $GRADLE_EXIT
          fi
      
      - name: Find built JAR
        id: find_jar
        run: |
          # Find the mod JAR (exclude sources and dev jars)
          MOD_FILE=$(find build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-dev.jar" | head -1)
          if [ -z "$MOD_FILE" ]; then
            echo "Error: No mod JAR found!"
            exit 1
          fi
          echo "Found: $MOD_FILE"
          echo "mod_file=$MOD_FILE" >> $GITHUB_OUTPUT
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.MOD_NAME }}-${{ steps.build_info.outputs.loader_type }}-${{ steps.build_info.outputs.mc_version }}
          path: build/libs/*.jar
          retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.release == 'true')
    
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ env.MOD_NAME }}-${{ needs.build.outputs.loader_type }}-${{ needs.build.outputs.mc_version }}
          path: ./artifacts
      
      - name: Get current date
        id: date
        run: echo "date=$(date +'%Y%m%d_%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build.outputs.loader_type }}-${{ needs.build.outputs.mc_version }}-${{ steps.date.outputs.date }}
          name: "${{ env.MOD_NAME }} ${{ env.MOD_VERSION }} - ${{ needs.build.outputs.loader_type }} ${{ needs.build.outputs.mc_version }}"
          body: |
            ## PromptCraft ${{ env.MOD_VERSION }}
            
            **分支**: `${{ needs.build.outputs.branch_name }}`
            **加载器**: ${{ needs.build.outputs.loader_type }}
            **Minecraft 版本**: ${{ needs.build.outputs.mc_version }}
            **构建时间**: ${{ steps.date.outputs.date }}
            
            ### 安装说明
            1. 下载下方的 JAR 文件
            2. 将 JAR 文件放入 `.minecraft/mods` 文件夹
            3. 确保已安装对应的模组加载器
            
            ---
            
            自动构建 by GitHub Actions
          files: ./artifacts/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
